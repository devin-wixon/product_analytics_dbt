version: 2

models:
  - name: fct_user_funnel_base
    description: |
      Purpose: User funnel analysis tracking progression through invitation, registration, and activation phases.
      Granularity: One row per user.
      User Categories:
        - backfill: Users whose most recent user_invite_status is 'backfill' (manually backfilled users; will have dbt_valid_from = '1900-01-01'; may not have a null dbt_valid_to)
        - legacy: Non-backfill users with dbt_valid_from = '1900-01-01' (unknown entry date)
        - sso: Users whose most recent user_invite_status is 'sso' (and not backfill/legacy)
        - username_password: All other users (not backfill, not legacy, not sso)
      Funnel Phases by Category:
        - backfill: created -> active -> active on 2+ days (null month_start_date)
        - legacy: created -> active -> active on 2+ days (null month_start_date)
        - sso: created -> active -> active on 2+ days (tracked by month_start_date)
        - username_password: created -> not_invited -> invited -> registered -> active -> active on 2+ days (tracked by month_start_date)
      Notes:
        - Backfill and legacy users have null month_start_date and represent "status as of today"
        - Not invited, invitation, and registration phases only apply to username_password users
        - Username_password users who never had a status but have events are inferred to have passed through invited/registered (with null dates)
        - Username_password users without events get false for phases they never had
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - user_id

    columns:
      - name: user_category
        description: |
          User category based on most recent dbt_valid_from and user_invite_status.
          Values: 'legacy', 'sso', 'backfill', 'username_password'
          Legacy users have dbt_valid_from = '1900-01-01' and unknown entry date.
        tests:
          - not_null
          - accepted_values:
              values: ['legacy', 'sso', 'backfill', 'username_password']

      - name: month_start_date
        description: |
          First month the user entered the system.
          Null for backfill and legacy users (unknown entry date).
          For sso/username_password users: first month they had any record in dim_users_history.

      - name: user_id
        description: "{{ doc('user_id') }}"
        tests:
          - unique
          - not_null

      - name: is_user_created
        description: |
          Boolean flag indicating user has been created.
          Always true for all users.
        tests:
          - not_null
          - accepted_values:
              values: [true]

      - name: is_user_not_invited
        description: |
          Boolean flag indicating user was ever in not_invited status.
          Null for legacy/sso/backfill users (not_invited phase does not apply).
          For username_password users: true if ever had user_invite_status of 'not_invited', false otherwise.

      - name: min_user_not_invited_date
        description: |
          Earliest dbt_valid_from date when user_invite_status was 'not_invited'.
          Null for legacy/sso/backfill users or username_password users who never had not_invited status.

      - name: is_user_invited
        description: |
          Boolean flag indicating user was ever invited or has events.
          Null for legacy/sso/backfill users (invitation phase does not apply).
          For username_password users: true if had user_invite_status of 'invited' OR has any events, false otherwise.

      - name: min_user_invited_date
        description: |
          Earliest dbt_valid_from date when user_invite_status was 'invited'.
          Null for legacy/sso/backfill users, or username_password users who were inferred (have events but no 'invited' record).

      - name: is_user_registered
        description: |
          Boolean flag indicating user was ever registered or has events.
          Null for legacy/sso/backfill users (registration phase does not apply).
          For username_password users: true if had user_invite_status of 'registered' OR has any events, false otherwise.

      - name: min_user_register_date
        description: |
          Earliest dbt_valid_from date when user_invite_status was 'registered'.
          Null for legacy/sso/backfill users, or username_password users who were inferred (have events but no 'registered' record).

      - name: is_user_active
        description: |
          Boolean flag indicating user had at least one event on any day.
          Applies to all user categories.
        tests:
          - not_null

      - name: min_user_active_date
        description: |
          Earliest server_event_date from fct_events for this user.
          Null if user has never had any events.

      - name: is_user_active_two_days
        description: |
          Boolean flag indicating user had events on 2 or more distinct days.
          Applies to all user categories.
        tests:
          - not_null

      - name: second_user_active_date
        description: |
          Second active day (server_event_date) for this user.
          Null if user has been active on less than 2 days.

      - name: n_user_active_days
        description: |
          Total count of distinct days the user had events.
          Zero if user has never had any events.
        tests:
          - not_null

      - name: days_elapsed_first_to_second_active_day
        description: |
          Number of days between first and second active day.
          Null if user has not been active on 2+ days.
