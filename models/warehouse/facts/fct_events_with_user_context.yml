version: 2

models:
  - name: fct_events_with_user_context
    description: |
      Purpose: Event-level fact table enriched with temporally accurate user context (role, district) as of event date.
      Granularity: One row per event occurrence.
      Filters: Includes all events with user context matched using exact or fallback SCD logic.
      Notes: Foundation model for semantic layer - maintains event-level grain while providing user and district dimensions.

      Technical Details:
      - Joins fct_events with int_users_district_role_date to get user context as of event date
      - Further joins with dim_districts_most_recent to get district attributes
      - Left joins ensure all events are preserved even if user context is not found
      - match_type dimension indicates whether user context was matched exactly or via fallback logic
    tests:
      # Verify no row loss during joins
      - dbt_utils.equal_rowcount:
          arguments:
            compare_model: ref('fct_events')
    columns:
      - name: event_id
        description: "{{ doc('event_id') }}"
        tests:
          - unique
          - not_null
      - name: server_timestamp
        description: "{{ doc('server_timestamp') }}"
      - name: client_timestamp
        description: "{{ doc('client_timestamp') }}"
      - name: user_id
        description: "{{ doc('user_id') }}"
      - name: event_name
        description: "{{ doc('event_name') }}"
      - name: event_category
        description: "{{ doc('event_category') }}"
      - name: event_type
        description: "{{ doc('event_type') }}"
      - name: event_value_human_readable
        description: "{{ doc('event_value_human_readable') }}"
      - name: server_event_date
        description: "{{ doc('server_event_date') }}"
      - name: client_event_date
        description: "{{ doc('client_event_date') }}"
      - name: path_entered
        description: "{{ doc('path_entered') }}"
      - name: path_left
        description: "{{ doc('path_left') }}"
      - name: program_id
        description: "{{ doc('program_id') }}"
      - name: resource_id
        description: "{{ doc('resource_id') }}"
      - name: week_number
        description: "{{ doc('week_number') }}"
      - name: application_name
        description: "{{ doc('application_name') }}"
      - name: event_path
        description: "{{ doc('event_path') }}"
      - name: event_value
        description: "{{ doc('event_value') }}"
      - name: dbt_row_batch_id
        description: "{{ doc('dbt_row_batch_id') }}"

      # User context columns (from int_users_district_role_date)
      - name: user_role
        description: "User's role at the time of the event (teacher, admin, etc.). Matched using SCD Type 2 logic."
        tests:
          - not_null:
              config:
                severity: warn
                where: "user_id is not null"
      - name: user_invite_status
        description: "User's invite status at the time of the event. Matched using SCD Type 2 logic."
      - name: district_id
        description: "{{ doc('district_id') }} - District ID associated with the user at the time of the event."
      - name: match_type
        description: |
          Indicates the quality of temporal user context matching:
          - 'exact': Event date fell within user's valid_from/valid_to range
          - 'fallback': Nearest temporal neighbor was used (event date outside valid ranges)
          - null: No user context found (user_id is null or not in dim_users_history)

      # District context columns (from dim_districts_most_recent)
      - name: district_name
        description: "{{ doc('district_name') }}"
      - name: district_type
        description: "{{ doc('district_type') }}"
      - name: district_state
        description: "{{ doc('district_state') }}"
      - name: district_state_international
        description: "{{ doc('district_state_international') }}"
      - name: district_city
        description: "{{ doc('district_city') }}"
      - name: district_tags
        description: "District tags for categorization and filtering"
      - name: is_distributed_demo_district
        description: "{{ doc('is_distributed_demo_district') }}"
