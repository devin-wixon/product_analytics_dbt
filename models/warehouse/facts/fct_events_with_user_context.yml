version: 2

models:
  - name: fct_events_with_user_context
    description: |
      Purpose: Event-level fact table enriched with temporally accurate user context (role, district) as of event date.
      Granularity: One row per event occurrence.
      Filters: Includes all events with user context matched using exact or fallback SCD logic.
      Notes: Foundation model for semantic layer - maintains event-level grain while providing user and district dimensions.

      Technical Details:
      - Joins `fct_events` with int_users_district_role_date to get user context as of event date
      - Left joins ensure all events are preserved even if user context is not found
      - match_type dimension indicates whether user context was matched exactly or via fallback logic
    tests:
      # Verify no row loss during joins or incremental loading
      - dbt_utils.equal_rowcount:
          arguments:
            compare_model: ref('fct_events')
    columns:
      - name: event_id
        description: "{{ doc('event_id') }}"
        tests:
          - unique
          - not_null
      - name: dbt_row_batch_id
        description: "{{ doc('dbt_row_batch_id') }}"
      - name: server_timestamp
        description: "{{ doc('server_timestamp') }}"
      - name: client_timestamp
        description: "{{ doc('client_timestamp') }}"
      - name: user_id
        description: "{{ doc('user_id') }}"
      - name: event_name
        description: "{{ doc('event_name') }}"
      - name: event_category
        description: "{{ doc('event_category') }}"
      - name: event_type
        description: "{{ doc('event_type') }}"
      - name: event_value_human_readable
        description: "{{ doc('event_value_human_readable') }}"
      - name: server_event_date
        description: "{{ doc('server_event_date') }}"
      - name: client_event_date
        description: "{{ doc('client_event_date') }}"
      - name: path_entered
        description: "{{ doc('path_entered') }}"
      - name: path_left
        description: "{{ doc('path_left') }}"
      - name: program_id
        description: "{{ doc('program_id') }}"
      - name: resource_id
        description: "{{ doc('resource_id') }}"
      - name: week_number
        description: "{{ doc('week_number') }}"
      - name: application_name
        description: "{{ doc('application_name') }}"
      - name: event_path
        description: "{{ doc('event_path') }}"
      - name: event_value
        description: "{{ doc('event_value') }}"
      - name: dbt_row_batch_id
        description: "{{ doc('dbt_row_batch_id') }}"

      # User context columns (from int_users_district_role_date)
      - name: user_role_event_date
        description: "{{ doc('user_role') }}"
        tests:
          - not_null:
              config:
                severity: warn
                where: "user_id is not null"
      - name: user_invite_status_event_date
        description: "{{ doc('user_invite_status') }}"
      - name: district_id
        description: "{{ doc('district_id') }}"
      - name: match_type
        description: "{{ doc('user_role_match_type') }}"