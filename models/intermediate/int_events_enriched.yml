version: 2

models:
  - name: int_events_enriched
    description: |
      Purpose: Enriched events log with additional join keys and event flags derived from Lilypad events.
      Granularity: One row per event, uniquely identified by `event_id`.
      Filters: Limited to 100 rows in Development environment.
      Notes: Includes derived columns for program/resource joins, event type flags, and parsed path information.
    data_tests:
      # Allow up to 714 known orphaned resource_ids (events with resource_id not in resources snapshot)
      - dbt_utils.expression_is_true:
          name: orphan_resource_ids_below_threshold
          arguments:
            expression: |
              (
                select count(distinct resource_id)
                from {{ ref('int_events_enriched') }}
                where resource_id is not null
                  and resource_id not in (
                    select resource_id
                    from {{ ref('stg_craft__resources') }}
                    where resource_id is not null
                  )
              ) <= 714
      # Allow up to 5 known orphaned program_ids (events with program_id not in programs snapshot)
      - dbt_utils.expression_is_true:
          name: orphan_program_ids_below_threshold
          arguments:
            expression: |
              (
                select count(distinct program_id)
                from {{ ref('int_events_enriched') }}
                where program_id is not null
                  and program_id not in (
                    select program_id
                    from {{ ref('stg_craft__programs') }}
                    where program_id is not null
                  )
              ) <= 5
    columns:
      - name: event_id
        description: "{{ doc('event_id') }}"
        tests:
          - unique
          - not_null
      - name: server_timestamp
        description: "{{ doc('server_timestamp') }}"
      - name: client_timestamp
        description: "{{ doc('client_timestamp') }}"
      - name: user_id
        description: "{{ doc('user_id') }}"
      - name: event_name
        description: "{{ doc('event_name') }}"
      - name: event_path
        description: "{{ doc('event_path') }}"
      - name: event_value
        description: "{{ doc('event_value') }}"
      - name: event_category
        description: "{{ doc('event_category') }}"
      - name: event_type
        description: "{{ doc('event_type') }}"
        data tests:
          - not null
      - name: event_value_human_readable
        description: "{{ doc('event_value_human_readable') }}"
      - name: server_event_date
        description: "{{ doc('server_event_date') }}"
      - name: client_event_date
        description: "{{ doc('client_event_date') }}"
      - name: path_entered
        description: "{{ doc('path_entered') }}"
      - name: path_left
        description: "{{ doc('path_left') }}"
      - name: program_id
        description: "{{ doc('program_id') }}"
      - name: resource_id
        description: "{{ doc('resource_id') }}"
      - name: week_number
        description: "{{ doc('week_number') }}"
      - name: application_name
        description: "{{ doc('application_name') }}"
      - name: dbt_row_batch_id
        description: "{{ doc('dbt_row_batch_id') }}"
