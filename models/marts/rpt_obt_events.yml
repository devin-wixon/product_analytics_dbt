version: 2

models:
  - name: rpt_obt_events
    description: |
      Purpose: Comprehensive event reporting model combining user events with dimensional context for analytics.
      Granularity: One row per event, uniquely identified by `event_id`.
      Notes: Uses most recent version of program, resource, and district information. User attributes reflect the state at event time using SCD2 logic with fallback matching for data quality.
    tests:
      - dbt_utils.equal_rowcount:
          config:
            enabled: "{{ target.name != 'Development' }}"
          arguments:
            compare_model: source('lilypad', 'raw_lilypad__events_log')
    columns:
      # Event columns from fct_events
      - name: event_id
        description: "{{ doc('event_id') }}"
        data_tests:
          - unique
          - not_null
      - name: server_timestamp
        description: "{{ doc('server_timestamp') }}"
      - name: client_timestamp
        description: "{{ doc('client_timestamp') }}"
      - name: user_id
        description: "{{ doc('user_id') }}"
      - name: event_name
        description: "{{ doc('event_name') }}"
      - name: event_category
        description: "{{ doc('event_category') }}"
      - name: event_type
        description: "{{ doc('event_type') }}"
      - name: event_value_human_readable
        description: "{{ doc('event_value_human_readable') }}"
      - name: server_event_date
        description: "{{ doc('server_event_date') }}"
      - name: client_event_date
        description: "{{ doc('client_event_date') }}"
      - name: path_entered
        description: "{{ doc('path_entered') }}"
      - name: path_left
        description: "{{ doc('path_left') }}"
      - name: program_id
        description: "{{ doc('program_id') }}"
      - name: resource_id
        description: "{{ doc('resource_id') }}"
      - name: week_number
        description: "{{ doc('week_number') }}"
      - name: application_name
        description: "{{ doc('application_name') }}"
      - name: event_path
        description: "{{ doc('event_path') }}"
      - name: event_value
        description: "{{ doc('event_value') }}"
      - name: dbt_row_batch_id
        description: "{{ doc('dbt_row_batch_id') }}"
      - name: is_planner_event
        description: "{{ doc('is_planner_event') }}"

      # User columns from int_users_district_role_date
      - name: district_id
        description: "{{ doc('district_id') }}"
      - name: user_invite_status
        description: "{{ doc('user_invite_status') }}"
      - name: user_role
        description: "{{ doc('user_role') }}"
      - name: match_type
        description: "{{ doc('user_role_match_type') }}"

      # District columns from dim_districts_most_recent
      - name: district_name
        description: "{{ doc('district_name') }}"
      - name: district_type
        description: "{{ doc('district_type') }}"
      - name: district_state
        description: "{{ doc('district_state') }}"
      - name: district_website_slug
        description: "{{ doc('district_website_slug') }}"
      - name: is_distributed_demo_district
        description: "{{ doc('is_distributed_demo_district') }}"

      # Program columns from dim_programs_most_recent
      - name: program_name
      - name: program_age_group
      - name: is_program_supplemental
      - name: program_type
        description: "{{ doc('program_type') }}"
      - name: is_program_district_auto_add
        description: "{{ doc('is_program_district_auto_add') }}"
      - name: program_language
      - name: program_license_type
        description: "{{ doc('program_license_type') }}"
      - name: program_release_year
        description: "{{ doc('program_release_date') }}"
      - name: program_phase
        description: "{{ doc('program_phase') }}"
      - name: program_market_specific
        description: "{{ doc('program_market_specific') }}"
      - name: is_program_demo
        description: "{{ doc('is_program_demo') }}"

      # Resource columns from dim_resources_most_recent
      - name: resource_program_id
        description: "{{ doc('resource_program_id') }}"
      - name: resource_program_name
        description: "{{ doc('resource_program_name') }}"
      - name: resource_title
      - name: resource_focus_area
      - name: resource_type
        description: "{{ doc('resource_type') }}"

      # Date dimension columns from dim_day_datespine
      - name: week_monday_date
        description: "{{ doc('week_monday_date') }}"
      - name: month_start_date
        description: "{{ doc('month_start_date') }}"
      - name: day_of_week_number
        description: "{{ doc('day_of_week_number') }}"
      - name: day_of_month_number
        description: "{{ doc('day_of_month_number') }}"
      - name: day_of_year_number
        description: "{{ doc('day_of_year_number') }}"
      - name: week_of_year_number
        description: "{{ doc('week_of_year_number') }}"
      - name: month_of_year_number
        description: "{{ doc('month_of_year_number') }}"
      - name: quarter_of_year_number
        description: "{{ doc('quarter_of_year_number') }}"
      - name: short_weekday_name
        description: "{{ doc('short_weekday_name') }}"
      - name: short_month_name
        description: "{{ doc('short_month_name') }}"
      - name: year_month_sort
        description: "{{ doc('year_month_sort') }}"
      - name: year_quarter_sort
        description: "{{ doc('year_quarter_sort') }}"
      - name: school_year_label
        description: "{{ doc('school_year_label') }}"
      - name: school_year_start_date
        description: "{{ doc('school_year_start_date') }}"

      # Calculated column
      - name: client_timestamp_hour
        description: "{{ doc('client_timestamp_hour') }}"
