version: 2

models:
  - name: stg_lilypad__events_log
    description: |
      Purpose: Events log from Lilypad raw events, with column typing and renaming as needed.
      Granularity: One row per event, uniquely identified by `event_pk`.
      Notes: Includes Snowflake event ingestion metadata columns.
    data_tests:
    # ensure no more than 20 "orphan" users; may need to backfill from S3 if more
      - dbt_utils.expression_is_true:
          name: orphan_user_ids_below_threshold
          arguments:
            expression: |
              (
                select count(distinct user_id)
                from {{ ref('stg_lilypad__events_log') }}
                where user_id not in (
                  select id
                  from {{ ref('snp_taco__users') }}
                  where id is not null
                )
              ) <= 20
          config:
            severity: warn
    columns:
      - name: event_id
        description: "{{ doc('event_id') }}"
        data_tests:
          - not_null
          - unique
      - name: user_id
        description: "{{ doc('user_id') }}"
      - name: session_uuid
        description: "{{ doc('session_uuid') }}"
      - name: event_name
        description: "{{ doc('event_name') }}"
        data_tests:
          - relationships:
              arguments:
                to: ref('seed_event_log_metadata')
                field: event_name
      - name: event_path
        description: "{{ doc('event_path') }}"
      - name: event_value
        description: "{{ doc('event_value') }}"
      - name: event_value_human_readable
        description: "{{ doc('event_value_human_readable') }}"
      - name: server_timestamp
        description: "{{ doc('server_timestamp') }}"
      - name: client_timestamp
        description: "{{ doc('client_timestamp') }}"
      - name: _source_filename
        description: "{{ doc('_source_filename') }}"
      - name: _loaded_at_utc
        description: "{{ doc('_loaded_at_utc') }}"
