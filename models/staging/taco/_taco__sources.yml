version: 2

sources:
  - name: taco
    description: >
      "Tables extracted from the Taco Postgres database.
      Tables are overwritten daily and may have changes and deletes.
      For some sources, snapshots are used prior to staging to track changes at the extract cadence, daily."
    database: raw
    schema: postgres_extracts
    tables:
      - name: data_load_log
        description: "Metadata about data extracts and loads"
        columns:
          - name: load_log_pk
            description: ""
            tests:
              - unique
              - not_null
      - name: raw_taco__applications
        description: "Third-party applications such as Cognitive Toy Box"
        tests:
          - dbt_expectations.expect_table_columns_to_match_set:
              arguments:
                column_list:
                  ["id",
                  "name",
                  "url",
                  "meta_code",
                  "type",
                  "use_memberships",
                  "enabled",
                  "teachers_only"
                  ]
        columns:
          - name: id
            tests:
              - unique
              - not_null
      - name: raw_taco__district
        description: "District information"
        tests:
          - dbt_expectations.expect_table_columns_to_match_set:
              arguments:
                column_list:
                  ["id",
                  "parent_district_id",
                  "role_id",
                  "name",
                  "address",
                  "state",
                  "sales_force_id",
                  "mas_id",
                  "sage_id",
                  "last_sync",
                  "curriculum",
                  "type",
                  "settings",
                  "enabled",
                  "website_slug",
                  "city",
                  "sourced_id",
                  "identifier",
                  "roster_file_created_at",
                  "auto_rostering_checked_at",
                  "auto_sync",
                  "state_international",
                  "general_settings",
                  "tags",
                  "created_at",
                  "updated_at"
                  ]
        columns:
          - name: id
            tests:
              - unique
              - not_null
          # used for snapshot; ensure not null for SCD
          - name: updated_at
            tests:
              - not_null
      - name: raw_taco__districts_programs
        description: "Programs associated with each district"
         # ensure unique district x program combination; required for downstream models
        tests:
          - unique:
              column_name: "district_id || '-' || program_id"
          - dbt_expectations.expect_table_columns_to_match_set:
              arguments:
                column_list:
                  ["district_id",
                   "program_id",
                   "enabled",
                   "expiration_date",
                   "updated_at",
                   "created_at"
                  ]
        # no primary key in postgres; combination of district and program should be unique
        columns:
          - name: district_id
            tests:
              - not_null
          - name: program_id
            tests:
              - not_null
          # used for snapshot; ensure not null for SCD
          - name: updated_at
            tests:
              - not_null
       
      - name: raw_taco__district_applications
        description: "Applications (third-party products) associated with each district"
                # ensure unique district x application combination; required for downstream models
        tests:
          - unique:
              column_name: "district_id || '-' || application_id"
          - dbt_expectations.expect_table_columns_to_match_set:
              arguments:
                column_list:
                  ["id",
                    "district_id",
                    "application_id",
                    "create_date",
                    "enabled",
                    "abc_group_id",
                    "url",
                    "public_key",
                    "secret_key",
                    "api_prefix",
                    "created_at",
                    "updated_at"
                    ]
        columns:
          - name: id
            tests:
              - unique
              - not_null
          - name: district_id
            tests:
              - not_null
          - name: application_id
            tests:
              - not_null

      - name: raw_taco__district_application_licenses
        description: "Quantity and expiration dates for districts' applications (third-party products) licenses"
        tests:
          - dbt_expectations.expect_table_columns_to_match_set:
              arguments:
                column_list:
                  ["id",
                  "district_id",
                  "application_id",
                  "license",
                  "quantity_licenses",
                  "expiration_date",
                  "created_at",
                  "updated_at",
                  "deleted_at",
                  "sales_record"
                  ]
        columns:
          - name: id
            tests:
              - unique
              - not_null
      - name: raw_taco__district_program_licenses
        description: "Quantities and expiration dates of districts' program licenses"
        tests:
          - dbt_expectations.expect_table_columns_to_match_set:
              arguments:
                column_list:
                  ["id",
                  "district_id",
                  "program_id",
                  "license",
                  "quantity_licenses",
                  "expiration_date",
                  "created_at",
                  "updated_at",
                  "deleted_at",
                  "sales_record"
                  ]
        columns:
          - name: id
            tests:
              - unique
              - not_null

      - name: raw_taco__enrollments
        description: "Enrollments of users in schools or classes"
        # Schema change detection test - alerts if columns are added/removed
        # Required because snapshot uses hardcoded check_cols (timestamp strategy invalid)
        tests:
          - dbt_expectations.expect_table_columns_to_match_set:
              arguments:
                column_list:
                  [
                    "id",
                    "usersourcedid",
                    "classsourcedid",
                    "schoolsourcedid",
                    "usersourceid",
                    "role",
                    "user_id",
                    "class_id",
                    "primary",
                    "status",
                    "start_date",
                    "end_date",
                    "last_modified",
                    "active",
                    "district_id",
                    "sourced_id",
                    "school_id",
                    "role_id",
                    "updated_at",
                    "created_at"
                  ]
        columns:
          - name: id
            tests:
              - unique
              - not_null
          - name: user_id
            tests:
              - not_null
      - name: raw_taco__users
        description: "Information on teacher, student and administrator users"
        columns:
          - name: id
            tests:
              - unique
              - not_null
        # Schema change detection test - alerts if columns are added/removed
        # Required because snapshot uses hardcoded check_cols (timestamp strategy invalid)
        tests:
          - dbt_expectations.expect_table_columns_to_match_set:
              arguments:
                column_list:
                  [
                    "id",
                    "grades",
                    "identifier",
                    "status",
                    "sourced_id",
                    "deleted_at",
                    "role",
                    "email_sent",
                    "district_id",
                    "other_grades",
                    "invite_status",
                    "disable_auto_sync",
                    "manually_added",
                    "updated_at",
                    "created_at"
                  ]
