version: 2

sources:
  - name: taco
    description: >
      "Tables extracted from the Taco Postgres database.
      Tables are overwritten daily and may have changes and deletes.
      For some sources, snapshots are used prior to staging to track changes at the extract cadence, daily."
    database: raw
    schema: postgres_extracts
    tables:
      # - name: data_load_log
      #   description: "Metadata about data extracts and loads"
      #   freshness:
      #     # just want error; adding both for project evaluator test
      #     error_after: {count: 1, period: day}
      #     warn_after: {count: 1, period: day}
      #   loaded_at_field: extract_timestamp
      #   data_tests:
      #     - elementary.schema_changes:
      #         arguments:
      #           config:
      #             severity: warn
      #           tags: ["elementary"]
      #   columns:
      #     - name: load_log_pk
      #       data_tests:
      #         - unique
      #         - not_null
      - name: raw_taco__applications
        description: "Third-party applications such as Cognitive Toy Box"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
      - name: raw_taco__district
        description: "District current data; id = district_id"
        freshness:
          warn_after: {count: 1, period: day}
          error_after: {count: 2, period: day}
        loaded_at_field: updated_at
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          # used for snapshot; ensure not null for SCD
          - name: updated_at
            data_tests:
              - not_null
      - name: raw_taco__districts_programs
        description: "Programs associated with each district"
        freshness:
          warn_after: {count: 5, period: day}
          error_after: {count: 7, period: day}
        loaded_at_field: updated_at
         # ensure unique district x program combination; required for downstream models
        data_tests:
          - unique:
              column_name: "district_id || '-' || program_id"
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        # no primary key in postgres; combination of district and program should be unique
        columns:
          - name: district_id
            data_tests:
              - not_null
          - name: program_id
            data_tests:
              - not_null
          # used for snapshot; ensure not null for SCD
          - name: updated_at
            data_tests:
              - not_null
       
      - name: raw_taco__district_applications
        description: "Applications (third-party products) associated with each district"
        freshness:
          warn_after: {count: 5, period: day}
          error_after: {count: 7, period: day}
        loaded_at_field: updated_at
        # ensure unique district x application combination; required for downstream models
        data_tests:
          - unique:
              column_name: "district_id || '-' || application_id"
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          - name: district_id
            data_tests:
              - not_null
          - name: application_id
            data_tests:
              - not_null
          # used for snapshot; ensure not null for SCD
          - name: updated_at
            data_tests:
              - not_null

      - name: raw_taco__district_application_licenses
        description: "Quantity and expiration dates for districts' applications (third-party products) licenses"
        freshness:
          warn_after: {count: 5, period: day}
          error_after: {count: 7, period: day}
        loaded_at_field: updated_at
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          - name: updated_at
            data_tests:
              - not_null
          
      - name: raw_taco__district_program_licenses
        description: "Quantities and expiration dates of districts' program licenses"
        freshness:
          warn_after: {count: 5, period: day}
          error_after: {count: 7, period: day}
        loaded_at_field: updated_at
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          - name: updated_at
            data_tests:
              - not_null
      - name: raw_taco__enrollments
        description: "Enrollments of users in schools or classes"
        freshness:
          warn_after: {count: 1, period: day}
          error_after: {count: 2, period: day}
        loaded_at_field: updated_at
        # Schema change detection test - alerts if columns are added/removed
        # Required because snapshot uses hardcoded check_cols (timestamp strategy invalid)
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          - name: user_id
            data_tests:
              - not_null
          - name: updated_at
            data_tests:
              - not_null
          - name: status
            data_tests:
              - not_null
              - accepted_values:
                  arguments:
                    values: ['active', 'tobedeleted']
      - name: raw_taco__users
        freshness:
          warn_after: {count: 1, period: day}
          error_after: {count: 2, period: day}
        loaded_at_field: updated_at
        description: "Information on teacher, student and administrator users"
        # Schema change detection test - alerts if columns are added/removed
        # Required because snapshot uses hardcoded check_cols (timestamp strategy invalid)
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          - name: updated_at
            data_tests:
              - not_null
          - name: invite_status
            data_tests:
              - not_null
              - accepted_values:
                  arguments:
                    values: ['not_invited', 'invited', 'registered', 'sso', 'backfill']
      - name: raw_taco__classes
        description: "Class-level information from Taco"
        freshness:
          warn_after: {count: 5, period: day}
          error_after: {count: 10, period: day}
        loaded_at_field: updated_at
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
      - name: raw_taco__program_visibility_settings
        description: "Which users can access programs, by district, school and class."
        freshness:
          warn_after: {count: 3, period: day}
          error_after: {count: 5, period: day}
        loaded_at_field: updated_at
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
      - name: raw_taco__schools
        description: "School-level information from Taco."
        freshness:
          warn_after: {count: 3, period: day}
          error_after: {count: 5, period: day}
        loaded_at_field: updated_at
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
      - name: raw_taco__grades
        description: "Grade-level information from Taco."
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
      - name: raw_taco__district_grades
        description: "Grade levels associated with the district in Taco."
        freshness:
          warn_after: {count: 3, period: day}
          error_after: {count: 5, period: day}
        loaded_at_field: updated_at
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                  enabled: "{{ target.name == 'prod' }}"
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null