version: 2

sources:
  - name: taco
    description: >
      "Tables extracted from the Taco Postgres database.
      Tables are overwritten daily and may have changes and deletes.
      For some sources, snapshots are used prior to staging to track changes at the extract cadence, daily."
    database: raw
    schema: postgres_extracts
    tables:
      - name: data_load_log
        description: "Metadata about data extracts and loads"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: load_log_pk
            data_tests:
              - unique
              - not_null
      - name: raw_taco__applications
        description: "Third-party applications such as Cognitive Toy Box"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
      - name: raw_taco__district
        description: "District information"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          # used for snapshot; ensure not null for SCD
          - name: updated_at
            data_tests:
              - not_null
      - name: raw_taco__districts_programs
        description: "Programs associated with each district"
         # ensure unique district x program combination; required for downstream models
        data_tests:
          - unique:
              column_name: "district_id || '-' || program_id"
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        # no primary key in postgres; combination of district and program should be unique
        columns:
          - name: district_id
            data_tests:
              - not_null
          - name: program_id
            data_tests:
              - not_null
          # used for snapshot; ensure not null for SCD
          - name: updated_at
            data_tests:
              - not_null
       
      - name: raw_taco__district_applications
        description: "Applications (third-party products) associated with each district"
                # ensure unique district x application combination; required for downstream models
        data_tests:
          - unique:
              column_name: "district_id || '-' || application_id"
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          - name: district_id
            data_tests:
              - not_null
          - name: application_id
            data_tests:
              - not_null
          # used for snapshot; ensure not null for SCD
          - name: updated_at
            data_tests:
              - not_null

      - name: raw_taco__district_application_licenses
        description: "Quantity and expiration dates for districts' applications (third-party products) licenses"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          - name: updated_at
            data_tests:
              - not_null
          
      - name: raw_taco__district_program_licenses
        description: "Quantities and expiration dates of districts' program licenses"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          - name: updated_at
            data_tests:
              - not_null
      - name: raw_taco__enrollments
        description: "Enrollments of users in schools or classes"
        # Schema change detection test - alerts if columns are added/removed
        # Required because snapshot uses hardcoded check_cols (timestamp strategy invalid)
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          - name: user_id
            data_tests:
              - not_null
          - name: updated_at
            data_tests:
              - not_null
      - name: raw_taco__users
        description: "Information on teacher, student and administrator users"
        # Schema change detection test - alerts if columns are added/removed
        # Required because snapshot uses hardcoded check_cols (timestamp strategy invalid)
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_tests:
              - unique
              - not_null
          - name: updated_at
            data_tests:
              - not_null
          - name: invite_status
            data_tests:
              - not_null
              - accepted_values:
                  values: ['not_invited', 'invited', 'registered', 'sso', 'backfill']
