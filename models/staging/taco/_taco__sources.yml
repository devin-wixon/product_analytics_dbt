version: 2

sources:
  - name: taco
    description: >
      "Tables extracted from the Taco Postgres database.
      Tables are overwritten daily and may have changes and deletes.
      For some sources, snapshots are used prior to staging to track changes at the extract cadence, daily."
    database: raw
    schema: postgres_extracts
    tables:
      - name: data_load_log
        description: "Metadata about data extracts and loads"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: load_log_pk
            description: ""
            data_type: varchar
            data_tests:
              - unique
              - not_null
      - name: raw_taco__applications
        description: "Third-party applications such as Cognitive Toy Box"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_type: integer
            data_tests:
              - unique
              - not_null
          - name: name
            data_type: varchar
          - name: url
            data_type: varchar
          - name: meta_code
            data_type: varchar
          - name: type
            data_type: varchar
          - name: use_memberships
            data_type: boolean
          - name: enabled
            data_type: boolean
          - name: teachers_only
            data_type: boolean
      - name: raw_taco__district
        description: "District information"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_type: integer
            data_tests:
              - unique
              - not_null
          - name: parent_district_id
            data_type: integer
          - name: role_id
            data_type: integer
          - name: name
            data_type: varchar
          - name: address
            data_type: varchar
          - name: state
            data_type: varchar
          - name: sales_force_id
            data_type: varchar
          - name: mas_id
            data_type: varchar
          - name: sage_id
            data_type: varchar
          - name: last_sync
            data_type: timestamp
          - name: curriculum
            data_type: varchar
          - name: type
            data_type: varchar
          - name: settings
            data_type: json
          - name: enabled
            data_type: boolean
          - name: website_slug
            data_type: varchar
          - name: city
            data_type: varchar
          - name: sourced_id
            data_type: varchar
          - name: identifier
            data_type: varchar
          - name: roster_file_created_at
            data_type: timestamp
          - name: auto_rostering_checked_at
            data_type: timestamp
          - name: auto_sync
            data_type: boolean
          - name: state_international
            data_type: varchar
          - name: general_settings
            data_type: json
          - name: tags
            data_type: varchar
          - name: created_at
            data_type: timestamp
          # used for snapshot; ensure not null for SCD
          - name: updated_at
            data_type: timestamp
            data_tests:
              - not_null
      - name: raw_taco__districts_programs
        description: "Programs associated with each district"
         # ensure unique district x program combination; required for downstream models
        data_tests:
          - unique:
              column_name: "district_id || '-' || program_id"
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        # no primary key in postgres; combination of district and program should be unique
        columns:
          - name: district_id
            data_type: integer
            data_tests:
              - not_null
          - name: program_id
            data_type: integer
            data_tests:
              - not_null
          - name: enabled
            data_type: boolean
          - name: expiration_date
            data_type: date
          - name: created_at
            data_type: timestamp
          # used for snapshot; ensure not null for SCD
          - name: updated_at
            data_type: timestamp
            data_tests:
              - not_null
       
      - name: raw_taco__district_applications
        description: "Applications (third-party products) associated with each district"
                # ensure unique district x application combination; required for downstream models
        data_tests:
          - unique:
              column_name: "district_id || '-' || application_id"
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_type: integer
            data_tests:
              - unique
              - not_null
          - name: district_id
            data_type: integer
            data_tests:
              - not_null
          - name: application_id
            data_type: integer
            data_tests:
              - not_null
          - name: create_date
            data_type: timestamp
          - name: enabled
            data_type: boolean
          - name: abc_group_id
            data_type: varchar
          - name: url
            data_type: varchar
          - name: public_key
            data_type: varchar
          - name: secret_key
            data_type: varchar
          - name: api_prefix
            data_type: varchar
          - name: created_at
            data_type: timestamp
          - name: updated_at
            data_type: timestamp

      - name: raw_taco__district_application_licenses
        description: "Quantity and expiration dates for districts' applications (third-party products) licenses"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_type: integer
            data_tests:
              - unique
              - not_null
          - name: district_id
            data_type: integer
          - name: application_id
            data_type: integer
          - name: license
            data_type: varchar
          - name: quantity_licenses
            data_type: integer
          - name: expiration_date
            data_type: date
          - name: created_at
            data_type: timestamp
          - name: updated_at
            data_type: timestamp
          - name: deleted_at
            data_type: timestamp
          - name: sales_record
            data_type: varchar
      - name: raw_taco__district_program_licenses
        description: "Quantities and expiration dates of districts' program licenses"
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_type: integer
            data_tests:
              - unique
              - not_null
          - name: district_id
            data_type: integer
          - name: program_id
            data_type: integer
          - name: license
            data_type: varchar
          - name: quantity_licenses
            data_type: integer
          - name: expiration_date
            data_type: date
          - name: created_at
            data_type: timestamp
          - name: updated_at
            data_type: timestamp
          - name: deleted_at
            data_type: timestamp
          - name: sales_record
            data_type: varchar

      - name: raw_taco__enrollments
        description: "Enrollments of users in schools or classes"
        # Schema change detection test - alerts if columns are added/removed
        # Required because snapshot uses hardcoded check_cols (timestamp strategy invalid)
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_type: integer
            data_tests:
              - unique
              - not_null
          - name: usersourcedid
            data_type: varchar
          - name: classsourcedid
            data_type: varchar
          - name: schoolsourcedid
            data_type: varchar
          - name: usersourceid
            data_type: varchar
          - name: role
            data_type: varchar
          - name: user_id
            data_type: integer
            data_tests:
              - not_null
          - name: class_id
            data_type: integer
          - name: primary
            data_type: boolean
          - name: status
            data_type: varchar
          - name: start_date
            data_type: date
          - name: end_date
            data_type: date
          - name: last_modified
            data_type: timestamp
          - name: active
            data_type: boolean
          - name: district_id
            data_type: integer
          - name: sourced_id
            data_type: varchar
          - name: school_id
            data_type: integer
          - name: role_id
            data_type: integer
          - name: created_at
            data_type: timestamp
          - name: updated_at
            data_type: timestamp
      - name: raw_taco__users
        description: "Information on teacher, student and administrator users"
        # Schema change detection test - alerts if columns are added/removed
        # Required because snapshot uses hardcoded check_cols (timestamp strategy invalid)
        data_tests:
          - elementary.schema_changes:
              arguments:
                config:
                  severity: warn
                tags: ["elementary"]
        columns:
          - name: id
            data_type: integer
            data_tests:
              - unique
              - not_null
          - name: grades
            data_type: varchar
          - name: identifier
            data_type: varchar
          - name: status
            data_type: varchar
          - name: sourced_id
            data_type: varchar
          - name: deleted_at
            data_type: timestamp
          - name: role
            data_type: varchar
          - name: email_sent
            data_type: boolean
          - name: district_id
            data_type: integer
          - name: other_grades
            data_type: varchar
          - name: invite_status
            data_type: varchar
          - name: disable_auto_sync
            data_type: boolean
          - name: manually_added
            data_type: boolean
          - name: created_at
            data_type: timestamp
          - name: updated_at
            data_type: timestamp
