semantic_models:
  - name: sem_user_activity_all_dimensions
    description: |
      Purpose: User daily activity patterns across all event types and dimensions for flexible aggregation.
      Granularity: One row per user per day per dimensional context.
      Notes: Dynamically adapts to new event categories and supports flexible time grain aggregation.
    model: ref('fct_user_events_dims_daily')
    defaults:
      agg_time_dimension: server_event_date

    entities:
      - name: user_daily_context
        type: primary
        expr: user_daily_context_sk

      - name: user
        type: foreign
        expr: user_id

      - name: district
        type: foreign
        expr: district_id

      - name: program
        type: foreign
        expr: program_id

      - name: resource
        type: foreign
        expr: resource_id


    dimensions:
      # Dimensional context
      - name: user_id
        type: categorical
        description: "{{ doc('user_id') }}"

      - name: district_id
        type: categorical
        description: "{{ doc('district_id') }}"

      - name: program_id
        type: categorical
        description: "{{ doc('program_id') }}"

      - name: resource_id
        type: categorical
        description: "{{ doc('resource_id') }}"

      - name: application_name
        type: categorical
        description: "{ doc('application_name') }"
    
      - name: event_category
        type: categorical
        description: "{{ doc('event_category') }}"

      # Flexible time dimensions
      - name: server_event_date
        type: time
        description: "{{ doc('server_event_date') }}"
        type_params:
          time_granularity: day

      - name: metric_time_day
        type: time
        description: "Daily time dimension for user activity"
        expr: server_event_date
        type_params:
          time_granularity: day

      - name: metric_time_week
        type: time
        description: "Weekly time dimension for user activity"
        expr: server_event_date
        type_params:
          time_granularity: week

      - name: metric_time_month
        type: time
        description: "Monthly time dimension for user activity"
        expr: server_event_date
        type_params:
          time_granularity: month
          
      - name: metric_time_quarter
        type: time
        description: "Quarterly time dimension for user activity"
        expr: server_event_date
        type_params:
          time_granularity: quarter

      - name: metric_time_school_year
        type: time
        description: "Event client date aggregated to school year level (July 1 - June 30). Will produce the last day of the school year."
        expr: |
          case
            when month(server_event_date) >= {{ var('school_year_start_month') }}
            then date_from_parts(year(server_event_date) + 1, {{ var('school_year_end_month') }}, {{ var('school_year_end_day') }})
            else date_from_parts(year(server_event_date), {{ var('school_year_end_month') }}, {{ var('school_year_end_day') }})
          end
        type_params:
          time_granularity: day

    # measures:
    measures:
      - name: n_events_per_user_day_context
        description: "Count of events that we capture. Note that the count may change due to event logging changes, rather than due to user volume or user behavior."
        agg: sum
        expr: n_events_per_user_day_context
        create_metric: True
        label: "Count of Events in Context"

      - name: n_active_users_per_context
        description: "Count of unique users with any type of event that we capture within the filters."
        agg: count_distinct
        expr: user_id
        create_metric: True
        label: "Users with Events in Context"
        # - name: n_user_days_in_context
        #   agg: count_distinct
        #   expr: CONCAT(user_id, '|', server_event_date)
        #   create_metric: true

        # - name: days_active_per_user_week_in_context
        #   description: "Days active per user per week - for window calcs"
        #   agg: count_distinct
        #   expr: n_user_days_in_context
        #   agg_time_dimension: metric_time_week

        # - name: n_events_in_context
        #   description: "Sum of all events (clicks or other user behavior) that we capture, within the context (such as program and week) selected"
        #   agg: sum
        #   expr: n_events_per_user_day_context
        #   create_metric: true