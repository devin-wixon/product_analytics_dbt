semantic_models:
  - name: sem_events
    description: |
      Purpose: Event-level data for flexible metric calculation with full dimensional access.  
      Granularity: One row per event.  
      Notes: Provides maximum flexibility for cross-dimensional analysis (users x districts x resources x programs).  
    model: ref('fct_events')
    # client_event_date is going to be the date base for the date spine
    defaults:
      agg_time_dimension: client_event_date
    
    entities:
    # event_id is the primary key
      - name: event
        type: primary
        expr: event_id

      - name: user
        type: foreign
        expr: user_id

      - name: resource
        type: foreign
        expr: resource_id

      - name: district
        type: foreign
        expr: district_id

      - name: program
        type: foreign
        expr: program_id

      # - name: session
      #   type: foreign
      #   expr: session_uuid
    
    dimensions:
      # entities are needed as dimensions to filter values
      # or to group by 
      - name: program_id
        type: categorical
        description: "{{ doc('program_id') }}"

      - name: user_id
        type: categorical
        description: "{{ doc('user_id') }}"

      - name: resource_id
        type: categorical
        description: "{{ doc('resource_id') }}"

      - name: district_id
        type: categorical
        description: "{{ doc('district_id') }}"

    # other attributes
      - name: event_name
        type: categorical
        description: "{{ doc('event_name') }}"

      - name: event_category
        type: categorical
        description: "{{ doc('event_category') }}"

      - name: application_name
        type: categorical
        description: "{{ doc('application_name') }}"
        expr: application_name
        
      # booleans

      # date related; need to add metric_time dimensions for Tableau parameters
      - name: client_event_date
        type: time
        description: "{{ doc('client_event_date') }}"
        type_params:
          time_granularity: day

      - name: metric_time_day
        type: time
        description: "{{ doc('client_event_date') }}"
        expr: client_event_date
        type_params:
          time_granularity: day
          
      - name: metric_time_week
        type: time
        description: "Event client date aggregated to week level"
        expr: client_event_date
        type_params:
          time_granularity: week

      - name: metric_time_month
        type: time
        description: "Event client date aggregated to month level"
        expr: client_event_date
        type_params:
          time_granularity: month

      - name: metric_time_quarter
        type: time
        description: "Event client date aggregated to quarter level"
        expr: client_event_date
        type_params:
          time_granularity: quarter

      - name: metric_time_year
        type: time
        description: "Event client date aggregated to year level"
        expr: client_event_date
        type_params:
          time_granularity: year

      - name: metric_time_school_year
        type: time
        description: "Event client date aggregated to the last day of the school year level, such as 2025-06-30 for 24-25."
        expr: |
          case
            when month(client_event_date) >= {{ var('school_year_start_month') }}
            then date_from_parts(year(client_event_date) + 1, {{ var('school_year_end_month') }}, {{ var('school_year_end_day') }})
            else date_from_parts(year(client_event_date), {{ var('school_year_end_month') }}, {{ var('school_year_end_day') }})
          end
        type_params:
          time_granularity: day

      # - name: server_event_date
      #   type: time
      #   description: "{{ doc('server_event_date') }}"
      #   type_params:
      #     time_granularity: day
    
    measures:
      - name: n_events
        description: "Count of events that we capture. Note that the count may change due to event logging changes, rather than due to user volume or user behavior."
        agg: count
        expr: event_id
        create_metric: True
        label: "Count of Events"

      - name: n_active_users
        description: "Count of unique users with any type of event that we capture, excluding students"
        agg: count_distinct
        expr: user_id
        create_metric: True
        label: "Active Users"

      # - name: n_sessions
      #   description: "Count of unique sessions"
      #   agg: count_distinct
      #   expr: session_uuid

      # counts of resources, programs, apps
      # - name: n_resources_accessed
      #   description: "Count of unique resources accessed"
      #   agg: count_distinct
      #   expr: resource_id
      #   create_metric: True

      # - name: n_programs_accessed
      #   description: "Count of unique programs accessed"
      #   agg: count_distinct
      #   expr: program_id
      #   create_metric: True

      # - name: n_applications_launched
      #   description: "Count of unique applications (third party products such as Cognitive Toy Box) launched"
      #   agg: count_distinct
      #   expr: application_name
      #   create_metric: True

      
      # counts of events
      # - name: login_events
      #   description: "Count of login events"
      #   agg: count
      #   expr: event_id
      #   filter: |
      #     is_login_event = true