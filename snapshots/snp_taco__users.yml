version: 2

snapshots:
  - name: snp_taco__users
    relation: source('taco', 'raw_taco__users')
    config:
      unique_key: id
      strategy: check
      # exclude date_last_modified
      # because this is updated on every sync
      # and we don't want to trigger a change every time
      check_cols:
        - id
        - grades
        - identifier
        - status
        - sourced_id
        - deleted_at
        - role
        - email_sent
        - district_id
        - other_grades
        - invite_status
        - disable_auto_sync
        - manually_added
      hard_deletes: "new_record"
      # dbt_valid_to_current:  "{{ var('dbt_valid_to_current') }}"

    data_tests:
      # Monitor snapshot volume changes (1 standard deviation)
      # defaults are appropriate for daily batch monitoring
      #   daily bucket, 14d training, 2d detection, both directions, min 5 day training)
      - elementary.volume_anomalies:
          config:
            severity: warn
          arguments:
            anomaly_sensitivity: 1
          tags: ["elementary", "volume"]

      # Monitor deletion rate threshold (1%)
      - assert_snapshot_deletion_rate:
          config:
            severity: warn
          arguments:
            max_deletion_percentage: 1
          tags: ["elementary", "deletion-rate"]
